var volumeLevel,selectedResolution,curPlaybackRate,hidden,visibilityChange,iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;$(window).blur(function(){hidden="hidden",visibilityChange="visibilitychange"}),$(window).focus(function(){hidden="",visibilityChange=""});function Player(a,b){var c,d,f=this;this.$window=null,this.playerHandlers={},this.course=null,this.lessonType=null,this.lessonGUID=null,this.lessonTitle=null,this.subsEnabled=!!(localStorage.getItem("captionLang")&&"none"!=localStorage.getItem("captionLang")),this.localData={},"object"==typeof b&&(this.playerHandlers=b),this.defineSelector=function(){return"#courseVideoWrapper"},this.defineParameters=function(a,b){return"undefined"!=typeof a&&(this.course=a),"undefined"!=typeof b.id&&(this.lessonGUID=b.id),"undefined"!=typeof b.title&&(this.lessonTitle=b.title),"undefined"!=typeof b.lesson_type&&(this.lessonType=b.lesson_type),"string"==typeof b&&(this.lessonGUID=b),this},this.getCourse=function(){return this.course},this.getLesson=function(){return this.lessonGUID},this.getLessonTitle=function(){return this.lessonTitle},this.getLessonType=function(){try{var a=this.localData.data.response.link[0].type}catch(a){}return"undefined"==a?this.lessonType:a},this.setPlayerHandlers=function(a){return this.playerHandlers=a,this},this.setupPlayerHandlers=function(){var a=this;return $.each(this.playerHandlers,function(b,e){if("function"==typeof e&&c&&"prev"!==b||"next"!==b)try{c.off(b),c.on(b,e)}catch(a){try{c.dispose()}catch(a){}}d&&("loadeddata"==b&&d.on("lessonStarted",e),"playing"==b&&d.on("lessonStarted",e),"ended"==b&&d.on("lessonCompleted",e),"prev"==b&&d.on("playlistPrev",e.bind(null,a)),"next"==b&&d.on("playlistNext",e.bind(null,a)),"event"==b&&d.on("customEvent",e))}),this},this.updateNextPrev=function(a,b){null===a?this.$window.find("[rel=prev]").hide():this.$window.find("[rel=prev]").show(),null===b?this.$window.find("[rel=next]").hide():this.$window.find("[rel=next]").show()},this.hideNextPrev=function(){this.$window.find("[rel=prev]").hide(),this.$window.find("[rel=next]").hide()},this.stop=function(){"undefined"!=typeof c&&c.pause()},this.start=function(){"undefined"!=typeof c&&c.play()},this.showNextVideo=function(a,b,e,f,g){var h=this,i=f.captiontype?f.captiontype:"default";return i=iOS?"default":i,!c||c||"html"==h.getLessonType()?void this.show(a,b,e,f,g):void($("track").remove(),$("source").remove(),this.defineParameters(a,b),this.loadSource(a,b,f,g,i).done(function(){if("html"==h.getLessonType()){try{c.pause(),c.stop(),c.dispose()}catch(a){console.log("video player stopped");try{c.dispose()}catch(a){}}$(".video-js").hide(),d&&(d.dispose(),d=null),d=new WebPlayer,htmlplayer.addPlayer(h.lessonGUID,h.localData.data.response.link[0].file),d.setPlayer(h.lessonGUID),h.setupPlayerHandlers(),d.on("lessonStarted",function(){$("#"+e).css({height:"auto",width:"auto",margin:"auto"})});var a=h.sizeForHtmlPlayer();a.token="undefined"!=typeof $.cookie("LocalUserData")&&"undefined"!=typeof $.cookie("LocalUserData").sessionId?$.cookie("LocalUserData").sessionId:null,d.play("#"+e,a)}else{try{d.dispose()}catch(a){}$(".video-js").show(),$("video").append(h.localData.allTraks).attr("src",h.localData.data.response.link[0].file),c&&c.play()}}).fail(function(){}))},this.show=function(b,e,f,g,h){var i=this,j=$.Deferred();if("object"==typeof c){var k=document.getElementById("course_vjs_html5_api");if($("track").length&&$("track").each(function(){i.src=""}),k&&(k.src=""),c)try{c.dispose()}catch(a){console.log("resetting video player")}}try{d.dispose(),d=null}catch(a){d=null}this.defineParameters(b,e),this.$window=$(this.defineSelector());const l=this;var m=g.captiontype?g.captiontype:"default";m=iOS?"default":m;var n=!!g.fastForwardDisabled&&g.fastForwardDisabled,o=!!g.transcriptalt&&g.transcriptalt,p=g.stopVideoInHiddenTab?1:0;return $("#"+f).css({height:$(i.defineSelector()).height(),width:$(i.defineSelector()).width()}).html("Loading video..."),this.loadSource(b,e,g,h,m).done(function(){var b="<video  crossdomain crossorigin    = \"anonymous\" id             = \"course_vjs\" class          = \"video-js vjs-default-skin\" controls preload        = \"none\" width          = \"100%\"  >"+i.localData.allSources+i.localData.allTraks+"</video>";if(g.width=$("#"+f).width(),g.height=g.width/i.localData.aspectRatio.split(":")[0]*i.localData.aspectRatio.split(":")[1],$("#"+f).css({height:g.height+"px",width:g.width+"px","margin-bottom":"0px","padding-left":"0px"}).html(b),"html"==i.getLessonType()){try{c.pause(),c.stop(),c.dispose()}catch(a){console.log("video player stopped");try{c.dispose()}catch(a){}}$(".video-js").hide(),d=new WebPlayer,d.addPlayer(i.lessonGUID,i.localData.data.response.link[0].file),d.setPlayer(i.lessonGUID),i.setupPlayerHandlers(),d.on("lessonStarted",function(){$("#"+f).css({height:"auto",width:"auto",margin:"auto"})});var e=i.sizeForHtmlPlayer();e.token="undefined"!=typeof $.cookie("LocalUserData")&&"undefined"!=typeof $.cookie("LocalUserData").sessionId?$.cookie("LocalUserData").sessionId:null,d.play("#"+f,e)}else"video"==i.getLessonType()&&(c=videojs(document.getElementById("course_vjs"),{controls:!0,autoplay:g.autostart,aspectRatio:i.localData.aspectRatio,playbackRates:g.playbackRates||!1},function(){var b=selectedResolution||"high";if(c.videoJsResolutionSwitcher({default:b}),c.on("resolutionchange",function(){selectedResolution=c.currentResolution().label}),"4:3"==i.localData.aspectRatio&&($("#"+f).closest(".preview--course").addClass("four-by-three"),$(window).trigger("resize")),c.on("loadedmetadata",function(){document.getElementById("course_vjs").addEventListener("contextmenu",function(a){return a.preventDefault(),!1},!1);var a=i.subsEnabled&&0<i.localData.allTraks.length?95:30;$(l.defineSelector()).css({"margin-bottom":a+20+"px"}),$("#"+f).css({height:"auto",width:"auto",margin:"auto","margin-bottom":a+"px"}),1==p&&i.checkVisibility();var b="none";if("alternative"==m&&"object"==typeof g.tracks&&"undefined"!=typeof g.tracks[0]&&!g.disableCaptions){$(".video-js, .vjs-tech").addClass("video-only-bar"),$(".vjs-control-bar").addClass("video-permanent-bar"),$(".vjs-texttrack-settings").css("display","none");var d=g.sources[0].label,e=[];i.localData.vttLang[d]?e=i.localData.vttLang[d].data:i.localData.vttLang.en&&(e=i.localData.vttLang.en.data),"undefined"!=typeof defaultCaptionLang&&"alternative"==m&&e.length&&(e=vttLang[defaultCaptionLang].data,b="block",$(".video-js, .vjs-tech").removeClass("video-only-bar"),$(".video-js, .vjs-tech").addClass("video-bar-caption")),i.enableTranscript(o,n,e);var h=document.createElement("div");h.id="altcaption",h.className="altcaption",h.style.display=b,document.getElementById("course_vjs").appendChild(h),c.on("timeupdate",function(){if(!e.length){var a=localStorage.getItem("captionLang");if("undefined"==typeof b||!b)var b;b=a?a:"undefined"!=typeof defaultCaptionLang&&defaultCaptionLang?defaultCaptionLang:"en",b&&"undefined"!=typeof i.localData.vttLang[b]&&"undefined"!=typeof i.localData.vttLang[b].data&&(e=i.localData.vttLang[b].data,console.log("vtt fix applied"))}for(var d=c.currentTime(),f="",g="",h="",j=0,k=e.length;j<k;j++)if($("#transcript-tab-content a").removeClass("activeCue"),g=e[j],d>=g.timeA&&d<=g.timeB){f=g.text,h=j;break}try{document.getElementById("altcaption").innerHTML="<span class=\"cuealt\">"+f+"</span>"}catch(a){console.log("altcaption not found")}$("#phrase_"+h).addClass("activeCue")});var j=document.querySelector(".course_vjs-dimensions .vjs-captions-button ul");c.textTracks().on("change",function(){var a="captions off";if($.each(c.textTracks(),function(b,c){c&&"showing"==c.mode&&(a=c.language)}),$(".vjs-menu").removeClass("vjs-lock-showing"),$(".vjs-captions-button .vjs-menu").css({display:"none"}),"captions off"==a)localStorage.setItem("captionLang","none"),document.getElementById("altcaption").style.display="none",$(".video-js, .vjs-tech").addClass("video-only-bar"),$(".video-js, .vjs-tech").removeClass("video-bar-caption"),i.subsEnabled&&($("#"+f).css({"margin-bottom":"30px"}),$(l.defineSelector()).css({"margin-bottom":"50px"}),i.subsEnabled=!1),i.disableTranscript();else{localStorage.setItem("captionLang",a),document.getElementById("altcaption").style.display="block","undefined"!=typeof i.localData.vttLang[a]&&i.localData.vttLang[a].dir&&(document.getElementById("altcaption").style.direction=i.localData.vttLang[a].dir),$(".video-js, .vjs-tech").removeClass("video-only-bar"),$(".video-js, .vjs-tech").addClass("video-bar-caption"),i.subsEnabled||($("#"+f).css({"margin-bottom":"95px"}),$(l.defineSelector()).css({"margin-bottom":"115px"}),i.subsEnabled=!0);var b=a;i.localData.vttLang[b]?(e=i.localData.vttLang[b].data,i.enableTranscript(o,n,e)):i.disableTranscript()}i.fixMiniPlayer()});var k=localStorage.getItem("captionLang");k?"none"!=k&&i.localData.vttLang[k]&&$(j).find(":contains('"+k+"')").click():"en"!=d&&i.localData.vttLang.en&&$(j).find(":contains('"+i.localData.vttLang.en.lang+"')").click()}else i.disableTranscript();"number"==typeof curPlaybackRate&&c.playbackRate(curPlaybackRate),$(".vjs-menu-item").click(function(){curPlaybackRate=c.playbackRate()})}),!0==n&&!1==o){function b(b){a.showAlert(b,!0),e=!0,$("input[rel=\"closeOk\"]").on("click",function(){$("body").removeAttr("style"),e=!1,c.play()})}var d=0,e=0;c.on("seeking",function(){d<c.currentTime()&&(c.currentTime(d),$("input[rel=\"closeOk\"]").off("click"),b(g.errorMsg?g.errorMsg:"Error message!"))}),setInterval(function(){e&&c.pause(),c.paused()||(d=c.currentTime())},1e3)}"number"==typeof volumeLevel&&c.volume(volumeLevel),c.on("volumechange",function(){volumeLevel=c.volume()}),i.setupPlayerHandlers()}));j.resolve()}).fail(function(a){j.reject(a)}),j},this.loadSource=function(a,b,c,d,e){var f=$.Deferred();this.localData.data={};const g=this;var h=null,j=config.APIUrl;"undefined"!=typeof c.lang&&c.lang||(c.lang="en");var k=j+"courses/0"+a+"/lessons/"+this.getLesson()+"/videos/0"+c.lang+"/",l=[];if(null!=h&&(l[0]="token="+h),"object"==typeof d&&$.each(d,function(a,b){l[l.length]=a+"="+b}),"undefined"!=typeof STUDENT_ID&&STUDENT_ID?l[l.length]="studentID="+STUDENT_ID:"undefined"!=typeof _this&&"undefined"!=typeof _this.siteApi&&"undefined"!=typeof _this.siteApi.session&&"undefined"!=typeof _this.siteApi.session.email&&_this.siteApi.session.email?l[l.length]="studentID=kc-"+_this.siteApi.session.email:"undefined"!=typeof SESSION&&"undefined"!=typeof SESSION._amember_id&&SESSION._amember_id&&(l[l.length]="studentID="+SESSION._amember_id),l[l.length]="_="+new Date().getTime(),0<l.length){k+="?";for(var m=0;m<l.length;m++)k+=l[m],l[m+1]&&(k+="&")}return $.getJSON(k,function(a){if(!a.response.link)return f.reject(),void alert("error: bad video url");"string"==typeof a.response.link?c.file=a.response.link:"object"==typeof a.response.link&&(c.sources=[],$.each(a.response.link,function(a,b){c.sources[a]={file:b.file,label:b.label,default:!!b.is_default},b.resolutions&&(c.sources[a].resolutions=b.resolutions)})),"string"==typeof a.response.previewImage&&"undefined"!=typeof c.image&&(c.image=a.response.previewImage),"object"!=typeof a.response.captions||c.disableCaptions||(c.tracks=[],$.each(a.response.captions,function(a,b){c.tracks[a]={file:b.file,label:b.label,default:!!b.is_default,kind:b.kind,dir:"ar"==b.label?"rtl":"ltr"}}));var b=null==a.response.link[0].videoAspectRatio?"4:3":a.response.link[0].videoAspectRatio;var d;if("alternative"==e&&!c.disableCaptions){!1==$("style").hasClass("vjs-text-track-display-st")&&$("head").append("<style class=\"vjs-text-track-display-st\"> ::cue {opacity:0;} video::-webkit-media-text-track-container {opacity:0;} video::-webkit-media-text-track-background {opacity:0;} video::-webkit-media-text-track-display {opacity:0;} .vjs-text-track-display {display:none;} </style>"),"4:3"==b?($("style.course_vjs-dimensions.vjs-fluid").remove(),$("head").append("<style class=\"course_vjs-dimensions vjs-fluid\">.course_vjs-dimensions.vjs-fluid{padding-top:75%}</style>")):($("style.course_vjs-dimensions.vjs-fluid").remove(),$("head").append("<style class=\"course_vjs-dimensions vjs-fluid\">.course_vjs-dimensions.vjs-fluid{padding-top:56.25%}</style>"));var h={};$.each(c.tracks,function(a){$.get(c.tracks[a].file,function(b){h[c.tracks[a].label]={lang:c.tracks[a].label,data:g.parseVTT(b),dir:c.tracks[a].dir}})}),d=g.renderTracks(c)}else d=g.renderTracks(c);g.localData={data:a,allSources:g.renderTwoSources(c),allTraks:d,aspectRatio:b,vttLang:h},f.resolve()}).fail(function(a,b){let c=$.parseJSON(a.responseText);if("undefined"!=typeof c.response&&"undefined"!=typeof c.response.message){let a=c.response.message;if(a.match(/^TRAINING_LIMIT/i))return f.reject({status:"error",error:"TRAINING_LIMIT"}),void("function"==typeof g.playerHandlers.error&&g.playerHandlers.error.call(this,{status:"error",error:"TRAINING_LIMIT"}))}f.reject({status:b,response:c})}),f},this.renderTwoSources=function(a){var b="";return $.each(a.sources,function(a,c){var d=!1;c.resolutions?($.each(c.resolutions,function(a,c){b+="<source src=\""+c+"\" type=\"video/mp4\" label=\""+a+"\" res=\""+a+"\" >",d=720==+a}),!d&&(b+="<source src=\""+c.file+"\" type=\"video/mp4\" label=\"720\" res=\"720\" >")):b+="<source src=\""+c.file+"\" type=\"video/mp4\" label=\""+c.label+"\">"}),b},this.renderSources=function(a){var b="";return $.each(a.sources,function(a,c){c.resolutions?$.each(c.resolutions,function(a,c){b+="<source src=\""+c+"\" type=\"video/mp4\" label=\""+a+"\" res=\""+a+"\" >"}):b+="<source src=\""+c.file+"\" type=\"video/mp4\" label=\""+c.label+"\">"}),b},this.renderTracks=function(a){var b="";return $.each(a.tracks,function(c){var d=a.tracks[c],e="";"undefined"!=typeof defaultCaptionLang&&defaultCaptionLang==d.label&&(e=" default "),b+="<track crossorigin kind=\""+d.kind+"\" label=\""+d.label+"\" srclang=\""+d.label+"\" src=\""+d.file+"\""+e+">"}),b},this.onPrev=function(a,b){if(b.preventDefault(),"function"==typeof this.playerHandlers.prev){var c=this.playerHandlers.prev;c(this,b)}},this.onNext=function(a,b){if(b.preventDefault(),"function"==typeof this.playerHandlers.next){var c=this.playerHandlers.next;c(this,b)}},this.onMove=function(a,b){b.preventDefault();var d=$(a).attr("data-time");c.currentTime(d),c.play()},this.parseVTT=function(a){var b=a.split("WEBVTT"),c=b[1].split("\n\r"),d=[],e=0;return $.each(c,function(a){var b=c[a].split("\n"),f=b.filter(function(a){return a.length&&isNaN(a)});if(1>=f.length)return!0;var g=f[0].split(" --> ");if(g[1]){var h=g[0].split(":"),i=60*(60*+h[0])+60*+h[1]+ +h[2],j=g[1].split(":"),k=60*(60*+j[0])+60*+j[1]+ +j[2];d[e]={number:e,timeA:i,timeB:k,text:f[1]+(f[2]?"<br>"+f[2]:"")},e++}}),d},this.enableTranscript=function(b,c,d){var e=this;if(b&&!c&&d.length){var f=d.map(function(a,b){return"<a href=\"#!\" id=\"phrase_"+b+"\" data-handler=\"onMove\"  data-time=\""+a.timeA+"\">"+a.text.replace("<br>","")+"</a>"}).join(" ");$("#transcriptTab").css({visibility:"visible"}).removeClass("hidden"),document.getElementById("transcript-tab-title").innerHTML=e.getLessonTitle(),document.getElementById("transcript-tab-content").innerHTML=f,a.assignPageHandlers("#transcript-tab-content",e)}},this.disableTranscript=function(){$("#transcriptTab").css({visibility:"hidden"})},this.checkVisibility=function(){$(document).off(".visible");var a=function(){"hidden"==hidden&&c.pause()};$(window).on("blur.visible",document,a)},this.handleResize=function(){var a=this.getLessonType();if(!a)return!1;if("html"==a)try{let a=this.sizeForHtmlPlayer();d.resize(a.width,a.height)}catch(a){console.log("html player not ready to resize")}},this.fixMiniPlayer=function(){if(!0==$("div").hasClass("playing-view__panel")){var a=$(".playing-view__panel").offset();if(100<=a.top&&$(document).scrollTop()>a.top){var b=$(document).scrollTop()+$(window).height()-($(document).height()-$("#footer").height());-10<b?$("#courseVideoWrapper").attr("style","position:fixed; right:20px;bottom:"+(b+30)+"px; height: auto; min-height: 104px; width: 247.5px; z-index: 100; display: block !important;margin:0px;"):$("#courseVideoWrapper").attr("style","position:fixed; right:20px;bottom:20px; height: auto; min-height: 104px; width: 247.5px; z-index: 100; display: block !important;margin:0px;"),$(".course-video__arrow").hide(),"none"===$("#altcaption").css("display")?$("#courseVideoEmbed").attr("style",""):$("#courseVideoEmbed,#courseVideoWrapper").attr("style","")}}},this.sizeForHtmlPlayer=function(){let b=$(this.defineSelector()).width(),c=b/this.localData.aspectRatio.split(":")[0]*this.localData.aspectRatio.split(":")[1]+30;return $(window).width()<$(window).height()&&(c=1.5*b-40),{width:b,height:c,lang:a.getLanguage()}},this.dispose=function(){try{c.stop()}catch(a){}try{c.dispose()}catch(a){}try{d.dispose()}catch(a){}try{$(window).off("resize",this.handleResizeRef)}catch(a){}},this.getCurrentPlayer=function(){return c},this.handleResizeRef=function(a){f.handleResize(a)},$(window).resize(this.handleResizeRef)}
